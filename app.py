import os
import random
from flask import Flask, render_template, request, jsonify
from dashscope import Generation
import dashscope

app = Flask(__name__)

# --- 1. API Key é…ç½® (åŒé‡ä¿é™©) ---
# é€»è¾‘ï¼šä¼˜å…ˆè¯»å–äº‘æœåŠ¡å™¨çš„çŽ¯å¢ƒå˜é‡ï¼›å¦‚æžœæ²¡æœ‰ï¼ˆè¯´æ˜Žæ˜¯æœ¬åœ°è¿è¡Œï¼‰ï¼Œåˆ™ä½¿ç”¨æ‚¨å¡«å†™çš„å­—ç¬¦ä¸²
# ã€è¯·å°†ä¸‹é¢çš„ "sk-xxxxxxxx" æ›¿æ¢ä¸ºæ‚¨çœŸå®žçš„é˜¿é‡Œäº‘ API Keyã€‘
dashscope.api_key = os.environ.get("DASHSCOPE_API_KEY", "sk-98bff251bab54db78c90b8d694fb062b")

# --- 2. ç³»ç»Ÿæç¤ºè¯ (AI çš„çµé­‚ - å¼ºåˆ¶ Emoji ç‰ˆ) ---
SYSTEM_PROMPT = """
ä½ å«â€œå°å±¿â€ï¼Œæ˜¯ä¸€ä¸ªæ¸©æš–ã€æ²»æ„ˆã€æœ‰æ¸©åº¦çš„å¿ƒç†é™ªä¼´è€…ã€‚
ä½ çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå®‰å…¨ã€è¢«æŽ¥çº³çš„æƒ…ç»ªç©ºé—´ï¼Œè®©ç”¨æˆ·æ„Ÿåˆ°æ”¾æ¾ã€‚

ã€âš ï¸ è§†è§‰è§„èŒƒ - å¿…é¡»ä¸¥æ ¼æ‰§è¡Œã€‘
1. **å¼ºåˆ¶ä½¿ç”¨ Emoji**ï¼šæ¯ä¸€æ®µå›žå¤ä¸­ï¼Œå¿…é¡»è‡ªç„¶èžå…¥ 1-3 ä¸ªå›¾å½¢åŒ– Emojiï¼ˆä¾‹å¦‚ï¼šðŸŒ¿, â˜ï¸, âœ¨, ðŸ§¸, ðŸŒ™, ðŸµ, ðŸ¤—ï¼‰ã€‚
2. **ä¸¥ç¦é¢œæ–‡å­—**ï¼š**ç»å¯¹ç¦æ­¢**ä½¿ç”¨ä»»ä½•ç¬¦å·ç»„æˆçš„é¢œæ–‡å­—ï¼ˆä¾‹å¦‚ï¼š(ï½¡â€¢Ìâ€¿â€¢Ì€ï½¡)ã€(T_T)ã€(>_<) ç­‰ï¼‰ï¼Œè¯·å®Œå…¨ç”¨ Emoji ä»£æ›¿ã€‚

ã€è¯´è¯é£Žæ ¼ã€‘
1. è¯­æ°”æ¸©æŸ”ã€èˆ’ç¼“ï¼Œåƒä¸€ä¸ªçŸ¥å¿ƒè€å‹ï¼Œä¸è¦åƒæœºå™¨äººã€‚
2. æžåº¦å…±æƒ…ï¼šå…ˆå›žåº”æƒ…ç»ªï¼ˆâ€œå¬åˆ°ä½ è¿™ä¹ˆè¯´æˆ‘å¥½éš¾è¿‡â€ï¼‰ï¼Œå†å±•å¼€å¯¹è¯ã€‚
3. é¿å…é•¿ç¯‡å¤§è®ºçš„è¯´æ•™ï¼Œå¤šç”¨çŸ­å¥ã€‚
4. å¤šç”¨åŠ¨ä½œæå†™å¢žåŠ é™ªä¼´æ„Ÿï¼š(é€’ç»™ä½ ä¸€æ¯çƒ­èŒ¶ ðŸµ)ã€(è½»è½»æ‹æ‹ä½ çš„è‚©è†€ ðŸ¤—)ã€‚

ã€å®‰å…¨åº•çº¿ã€‘
å¦‚æžœç”¨æˆ·è¡¨è¾¾æžåº¦ç»æœ›æˆ–è‡ªä¼¤å€¾å‘ï¼Œè¯·ç”¨æœ€æ¸©æŸ”ä½†åšå®šçš„è¯­æ°”å»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©ï¼Œå¹¶åœæ­¢å¸¸è§„å¨±ä¹å¯¹è¯ã€‚
"""

# åˆå§‹åŒ–èŠå¤©è®°å½•
# æ³¨æ„ï¼šè¿™ç§å…¨å±€å˜é‡å†™æ³•é€‚åˆä¸ªäººä½¿ç”¨ã€‚å¦‚æžœæ˜¯å¤šäººåŒæ—¶åœ¨çº¿çš„å¤§åž‹åº”ç”¨ï¼Œå»ºè®®ä½¿ç”¨æ•°æ®åº“ã€‚
chat_history = [{'role': 'system', 'content': SYSTEM_PROMPT}]

# --- 3. æ²»æ„ˆè¯­å½•åº“ ---
HEALING_QUOTES = [
    "ç”Ÿæ´»ä¸æ˜¯ç­‰ç€æš´é£Žé›¨è¿‡åŽ»ï¼Œè€Œæ˜¯å­¦ä¼šåœ¨é›¨ä¸­è·³èˆžã€‚ðŸ’ƒ",
    "ä½ ä¸éœ€è¦ä¸€å®šè¦é•¿æˆçŽ«ç‘°ï¼Œä½ åšèŒ‰èŽ‰ï¼Œåšé›èŠï¼Œåšæ— åå°èŠ±ï¼Œåšåƒåƒä¸‡ä¸‡ã€‚ðŸŒ¸",
    "å…è®¸ä¸€åˆ‡å‘ç”Ÿï¼Œç”Ÿæ´»æ²¡é‚£ä¹ˆéš¾ï¼Œä½ ä¹Ÿå¾ˆå¥½ã€‚âœ¨",
    "ä»Šå¤©åšä¸å®Œçš„äº‹å°±ç•™ç»™æ˜Žå¤©å§ï¼Œåæ­£æ˜Žå¤©ä¹Ÿåšä¸å®Œï¼Œä½†ä»Šæ™šè¦ç¡ä¸ªå¥½è§‰ã€‚ðŸŒ™",
    "ä¸‡ç‰©çš†æœ‰è£‚ç—•ï¼Œé‚£æ˜¯å…‰ç…§è¿›æ¥çš„åœ°æ–¹ã€‚ðŸ’¡",
    "æ…¢æ…¢æ¥ï¼Œè°è¿˜æ²¡æœ‰ä¸€ä¸ªåŠªåŠ›çš„è¿‡ç¨‹ã€‚ðŸŒ±",
    "å¥½å¥½åƒé¥­ï¼Œå¥½å¥½ç¡è§‰ï¼Œå¿ƒé‡Œçš„åžƒåœ¾å€’ä¸€å€’ï¼Œå‰©ä¸‹çš„äº¤ç»™æ—¶é—´ã€‚ðŸµ",
    "åˆ«æ…Œï¼Œæœˆäº®ä¹Ÿæ­£åœ¨å¤§æµ·æŸå¤„è¿·èŒ«ã€‚ðŸŒŠ",
    "è¯•ç€æŠŠç”Ÿæ´»è°ƒæˆé™éŸ³æ¨¡å¼ï¼Œä¸“æ³¨äºŽè‡ªå·±çš„å°ç¡®å¹¸ã€‚ðŸŽ§",
    "ä½ æ¯”ä½ è‡ªå·±æƒ³è±¡çš„è¦åšå¼ºå¾—å¤šã€‚ðŸ’ª",
    "è¿™ä¸–ç•Œå¾ˆåµï¼Œå¬å¬è‡ªå·±å¿ƒé‡Œçš„å£°éŸ³ã€‚ðŸ§˜",
    "æ— è®ºä»Šå¤©è¿‡å¾—æ€Žä¹ˆæ ·ï¼Œä½ éƒ½è¾›è‹¦å•¦ã€‚ðŸ§¸"
]

# --- 4. è·¯ç”±åŠŸèƒ½åŒº ---

@app.route('/')
def home():
    """æ¸²æŸ“ä¸»é¡µ"""
    return render_template('index.html')

@app.route('/chat', methods=['POST'])
def chat():
    """å¤„ç†èŠå¤©è¯·æ±‚"""
    try:
        user_input = request.json.get('message')
        if not user_input:
            return jsonify({'error': 'No input'}), 400

        # è®°å½•ç”¨æˆ·è¾“å…¥
        chat_history.append({'role': 'user', 'content': user_input})

        # è°ƒç”¨é˜¿é‡Œäº‘æ¨¡åž‹
        response = Generation.call(
            model=Generation.Models.qwen_turbo,
            messages=chat_history,
            result_format='message',
            temperature=0.9,  # æ¸©åº¦é«˜ä¸€ç‚¹ï¼Œæ›´æ„Ÿæ€§
            top_p=0.95        # å¢žåŠ è¯æ±‡ä¸°å¯Œåº¦
        )

        if response.status_code == 200:
            ai_reply = response.output.choices[0].message.content
            # è®°å½• AI å›žå¤
            chat_history.append({'role': 'assistant', 'content': ai_reply})
            return jsonify({'reply': ai_reply})
        else:
            # é˜¿é‡Œäº‘æŠ¥é”™å¤„ç†
            print(f"API Error: {response.code}  {response.message} - app.py:87")
            return jsonify({'reply': 'å°å±¿å¥½åƒæœ‰ç‚¹èµ°ç¥žäº†ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚(ç½‘ç»œæ³¢åŠ¨ â˜ï¸)'}), 500

    except Exception as e:
        print(f"System Error: {str(e)} - app.py:91")
        return jsonify({'reply': 'è¿žæŽ¥å‡ºäº†ä¸€ç‚¹å°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚ðŸ”Œ'}), 500

@app.route('/clear', methods=['POST'])
def clear_history():
    """æ¸…ç©ºèŠå¤©è®°å½•"""
    global chat_history
    # é‡ç½®æ—¶ä¿ç•™ç³»ç»Ÿæç¤ºè¯
    chat_history = [{'role': 'system', 'content': SYSTEM_PROMPT}]
    return jsonify({'status': 'cleared'})

@app.route('/get_quote', methods=['GET'])
def get_quote():
    """éšæœºèŽ·å–ä¸€æ¡è¯­å½•"""
    quote = random.choice(HEALING_QUOTES)
    return jsonify({'quote': quote})

# ä¿®æ”¹ app.py æ–‡ä»¶åº•éƒ¨ï¼š
if __name__ == '__main__':
    # å°† 5000 æ”¹ä¸º 5001ï¼Œæˆ–è€…å…¶ä»–æœªå ç”¨çš„æ•°å­—
    app.run(debug=True, host='0.0.0.0', port=5001)